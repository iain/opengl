#!/usr/bin/env ruby -I lib -w

require 'socket'

dts = TCPServer.new('192.168.0.101', 31337)

Thread.abort_on_exception=true

@clients = []
@client_names = []

@client_matrix = []
loop do
  Thread.start(dts.accept) do |s|
    client_number = @clients.size
    @clients << s

    while(line = s.gets)
      command, info = line.split(': ')
      info.chomp!
      if command == "get"
        p @client_matrix
        requested_id = @client_names.index(info)
        s.puts @client_matrix[requested_id]
      end

      @client_matrix << info               if command == "matrix"
      p @client_names[client_number] = info  if command == "set_name"

      if command == "request"
        s.puts @client_matrix[client_number] if info == "matrix"
        s.puts "#{@client_names}"            if info == "players"
      end
    end

    s.close
  end
end
